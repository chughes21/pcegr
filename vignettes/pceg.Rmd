---
title: "The pcegr Package"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{The pcegr Package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The pcegr package can be used to fit Poisson Chain Event Graphs (PCEGs) and Zero-Inflated Poisson Chain Event Graphs (ZIPCEGs) to data. We will demonstrate the functionality of the package using an example based around knee pain. 

Suppose a study is carried out on the instances of knee pain in a population. For each individual, their age, weight and history of injury to the legs are recorded, along with the amount of instances of knee pain they suffered over a certain period of time, in years. This period of time is variable between individuals, and varies uniformly between 1 day and 2 years.

Each of the three covariates are binary, with values:
+ Age (A): Old or Young
+ Weight (W): Over(weight) or Normal
+ History (H): Yes or No

while the response variable of Knee Pain (K) is assumed to come from a Zero-Inflated Poisson process where the risk probability and intensity is dependent on these three covariates. For each individual, they are assumed to have a latent risk state (S), either At Risk or Risk Free, where those who are At Risk have a nonzero probability of suffering an instance of knee pain. 

For an individual with risk probability $\pi$ and Poisson intensity $\lambda$, the expected number of event counts $Y$ observed over time $t$ is $E[Y] = \pi \lambda t$. Assume instead that a Poisson process with rate $\mu$ was modelling the counts, with rate estimated as $\hat{\mu}$. We would expect (for a large sample size) that \[\hat{\mu} \simeq \pi \lambda.\] Now, if we assume for two populations with different covariates that having the same rate $\lambda$ means they have the same risk probability $\pi$, a significant simplification, then we can fit either a PCEG model or ZIPCEG model to the data set, and the estimated rates and risk probabilities should be in line with the relationship above.

We have simulated $N=10000$ observations for the knee pain data set from a zero-inflated Poisson distribution with uniformly distributed observation times. We have also assumed the simplification that individuals with the same rate have the same risk probabilities, across covariate combinations. The data has been simulated under the following conditional independence statements:
+ Weight is independent of Age: W $\indep$ A;
+ History is independent of Weight given Age: H $\indep$ W $\vert$ A;
+ Knee Pain (and thus State) is independent of Age given History and the individual is Overweight: K, S $\indep$ A $\vert$ H, W = "Over"

This simulation creates two data sets. The first, *knee_pain*, is the simulated data set, containing the true risk state for each individual. The second, *knee_pain_obs*, is the observed data set, which is simply *knee_pain* with the risk states removed. We can investigate these:
```{r}
library(pcegr)
head(knee_pain)
summary(knee_pain)
summary(knee_pain_obs)
```

First, we will fit a PCEG model to the data set. This requires specifying an effective sample size. The default choice for CEGs is usually the greatest number of categories a single variable takes, in this case 2. A sensitivity analysis can be carried out on the effects of this choice. 

As there are $2^3 = 8$ leaves, we will assume each has a prior weight of $a = \tfrac{2}{8} = 0.25$. In order to enforce a prior mean for the rate of 2.5, the simple average for the data set, we choose $b = \tfrac{0.25}{2.5}=0.1$. If we were to desire more bespoke priors for each leaf, they could be input as vectors rather than scalars.
```{r}

pmod<-pceg(knee_pain_obs,2,TRUE,TRUE, gamma_alpha = 0.25,gamma_beta = 0.1)
pmod$result
```

We can see that the model has correctly identified that the individuals of either Age who are Overweight with a History of injury are in the same stage, and likewise for those with No History. It has also correctly identified that History is independent of Weight given Age. 

We now can estimate the posterior expected values of the tranisiton probabilities for the covariates, and the rates for the response. 
```{r}
for(i in 0:3){
  print(value_extractor(knee_pain_obs,pmod,level_rel_final = i-3,zip=FALSE))
}
```
We can also find 95% highest density intervals for these parameters. For example:
```{r}
hdi_gamma_extractor(knee_pain_obs,pmod,zip=FALSE)
hdi_beta_extractor(knee_pain_obs,pmod,level_rel_final = -1, zip=FALSE)
```

We can also check the log marginal likelihood and Chi-square calculation for the model, to assess the fit. 

```{r}
pmod$lik
expected_count_calculator(knee_pain_obs,pmod,zip=FALSE)
```
In the Chi-square contribution matrix, we can see some large values. In particular, for the leaves with low rates, for example the first row, we can see large contributions for the higher event counts. This is because there are a much higher number of observed counts greater than 3 than we would expect based on the small rate. In contrast, for the leaves with higher rates, such as 4, 6 and 8, we can see that the contributions for the zero counts are much higher. This is because there are much more observed zero counts than would be expected with such a high rate. 

These results are all indicative of the true underlying model instead being a zero-inflated Poisson distribution. We now fit a ZIPCEG model to the data. 

TO fit a ZIPCEG model, we must first choose the method of parameter estimation. As time is variable, we cannot use the MLE or method of moments estimators. Thus, the choices are Gibbs sampling ("Gibbs"), numerical likelihood optimisation ("nlm") or the Expectation-Maximisation algorithm ("EM"). We will perform model selection using the first two choices.

We will keep the same effective sample size as for the PCEG, but we must consider the prior on the leaves. For a ZIPCEG, we want the risk free leaves to have zero prior hyperparameters, and the risk leaves will have the same hyperparameters as for the PCEG. The priors must be input as vectors, where every odd element is a risk free leaf and thus 0. There are 16 leaves in total, 8 of each type.
```{r}
a<-rep(c(0,0.,25),8)
b<-a/2.5
```

For the Gibbs sampler, we must also specify the hyperparameters of the Beta($c,d$) prior for the risk probability. We will assume each risk probability has the same prior. This prior should be cohesive with the prior in the tree itself, and thus we should have $c = d = \tfrac{2}{16} = 0.125$ for each risk probability.
```{r}
c<-0.125
d<-0.125
```
We will also run the Gibbs sampler for $N=10000$ iterations. When the parameeters are estimated using the Gibbs sampler, we will impute the states stochastically.
```{r}
zipmod1<-zipceg(knee_pain_obs,"Gibbs",iter=10000,variable_time = TRUE, gamma_alpha = a, gamma_beta = b, beta_c = c, beta_d = d)
```


